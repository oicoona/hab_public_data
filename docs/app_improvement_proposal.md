# App Improvement Proposal

대구 공공데이터 시각화 앱의 개선 사항 제안서입니다.

버전: v1.2.4
작성일: 2025-12-12
기준 문서: `docs/v1.2.4/note.md`

---

## 1. 개요

본 문서는 v1.2.4 버전 개발 과정에서 발견된 문제점들과 개선 사항들을 정리한 제안서입니다. 사용자 경험(UX) 개선 및 기능 안정성 향상을 목표로 합니다.

---

## 2. 현재 문제점 및 개선 사항

### 2.1 환경 변수 관리 개선

**문제점:**
- Anthropic API Key가 `.env` 파일에 있을 경우 자동 반영이 되지 않음
- 환경 변수 우선순위가 명확하지 않음

**제안:**
- 앱 시작 시 `.env` 파일 존재 여부 체크
- API Key 우선순위: `.env` 파일 → Streamlit secrets → 사용자 입력
- 환경 변수 로드 실패 시 명확한 안내 메시지 제공

**구현 방향:**
```python
# app.py 초기화 부분
import os
from dotenv import load_dotenv

# .env 파일 로드 (존재하는 경우)
load_dotenv()

# API Key 우선순위 적용
api_key = (
    os.getenv("ANTHROPIC_API_KEY") or  # .env 파일
    st.secrets.get("ANTHROPIC_API_KEY", None) or  # Streamlit secrets
    ""  # 사용자 입력 대기
)
```

**상태:** 🔄 수정 필요

---

### 2.2 지도 시각화 상태 유지 문제 해결

**문제점:**
- 첫 데이터에서 위도/경도가 있는 경우 지도 표시가 잘 됨
- 새로운 데이터를 불러오면 이전 탭에 표시된 지도 시각화가 사라지는 문제
- 각 데이터셋의 지도가 독립적으로 유지되지 않음

**제안:**
- 각 데이터셋의 지도 상태를 독립적으로 관리
- `st.session_state`에 데이터셋별 지도 객체 캐싱
- 탭 전환 시에도 이전 지도가 유지되도록 구현

**구현 방향:**
```python
# 데이터셋별 지도 상태 관리
if "map_cache" not in st.session_state:
    st.session_state.map_cache = {}

dataset_key = f"map_{dataset_name}"
if dataset_key not in st.session_state.map_cache:
    # 새로운 지도 생성 및 캐싱
    st.session_state.map_cache[dataset_key] = create_folium_map(...)

# 캐시된 지도 표시
st_folium(st.session_state.map_cache[dataset_key])
```

**상태:** 🔄 수정 필요

---

### 2.3 데이터 질의응답 UI/UX 개선

**문제점:**
- 질의 입력 후 입력창이 화면 아래로 밀려나는 문제
- 대화 내역이 누적되지 않고 새 질문마다 이전 내용이 사라짐
- 사용자가 스크롤을 반복해야 하는 불편함

**제안:**
- 입력창을 화면 하단에 고정 (Fixed position)
- 질문-답변 쌍을 시간순으로 위쪽에 누적 표시
- 새 질문 입력 시 이전 대화는 유지하고 새 답변만 아래에 추가
- 채팅 인터페이스와 유사한 UX 제공

**구현 방향:**
```python
# 대화 내역 관리
if "chat_history" not in st.session_state:
    st.session_state.chat_history = []

# 대화 내역 표시 (상단)
chat_container = st.container()
with chat_container:
    for i, (q, a) in enumerate(st.session_state.chat_history):
        st.markdown(f"**질문 {i+1}:** {q}")
        st.markdown(f"**답변 {i+1}:** {a}")
        st.divider()

# 입력창 (하단 고정) - st.chat_input 사용
user_input = st.chat_input("질문을 입력하세요")
if user_input:
    # 새 질문-답변 추가
    answer = get_answer(user_input, df)
    st.session_state.chat_history.append((user_input, answer))
    st.rerun()
```

**상태:** 🔄 수정 필요

---

### 2.4 데이터셋 요약 행수 확대 ✅

**문제점:**
- 데이터 질의응답 탭에서 데이터셋 요약 시 상위 3개 행만 표시
- 데이터 파악에 충분하지 않은 정보량

**제안:**
- 요약 표시 행수를 3개 → 10개로 확대
- 사용자가 더 많은 샘플 데이터를 확인할 수 있도록 개선

**구현 방향:**
```python
# 변경 전
summary = df.head(3)

# 변경 후
summary = df.head(10)
```

**상태:** ✅ 수정 완료

---

## 3. 우선순위

| 순위 | 항목 | 중요도 | 난이도 | 상태 |
|-----|------|--------|--------|------|
| 1 | 환경 변수 관리 개선 | 높음 | 낮음 | 🔄 수정 필요 |
| 2 | 지도 시각화 상태 유지 | 높음 | 중간 | 🔄 수정 필요 |
| 3 | 질의응답 UI/UX 개선 | 높음 | 중간 | 🔄 수정 필요 |
| 4 | 데이터셋 요약 행수 확대 | 중간 | 낮음 | ✅ 완료 |

---

## 4. 기대 효과

### 4.1 사용자 경험(UX) 향상
- 지도 시각화가 안정적으로 유지되어 데이터 탐색이 원활해짐
- 질의응답 인터페이스가 직관적으로 개선되어 대화 흐름 파악이 쉬워짐
- 더 많은 샘플 데이터 확인으로 데이터 이해도 향상

### 4.2 개발 환경 개선
- 환경 변수 관리 체계화로 배포 및 테스트 편의성 증가
- API Key 관리가 명확해져 협업 시 설정 오류 감소

### 4.3 안정성 향상
- 상태 관리 개선으로 예기치 않은 UI 초기화 방지
- 명확한 우선순위로 설정 충돌 최소화

---

## 5. 참고 사항

### 5.1 관련 문서
- `docs/constitution.md`: 프로젝트 개발 규칙 및 컨벤션
- `docs/v1.2.4/note.md`: v1.2.4 개선 사항 원본 메모

### 5.2 테스트 가이드
개선 사항 적용 후 다음 시나리오 테스트 필요:

1. **환경 변수 테스트**
   - `.env` 파일 존재/부재 시나리오
   - Streamlit secrets 우선순위 검증
   - API Key 로드 실패 시 안내 메시지 확인

2. **지도 상태 유지 테스트**
   - 여러 데이터셋 업로드 후 탭 전환
   - 새 데이터 업로드 후 이전 탭 확인
   - 세션 간 상태 초기화 확인

3. **질의응답 UI 테스트**
   - 연속 질문 입력 시 대화 내역 누적 확인
   - 입력창 위치 고정 확인
   - 스크롤 동작 확인

4. **데이터셋 요약 테스트**
   - 10개 이상 행 데이터 업로드 시 10개 행 표시 확인
   - 10개 미만 행 데이터 업로드 시 전체 표시 확인

---

## 6. 구현 계획

### 6.1 v1.2.5 (단기)
- [x] 데이터셋 요약 행수 확대 (완료)
- [ ] 환경 변수 관리 개선
- [ ] 지도 시각화 상태 유지 문제 해결
- [ ] 질의응답 UI/UX 개선

### 6.2 v1.3.0 (중기)
- 질의응답 기능 고도화 (대화 컨텍스트 유지, 데이터 참조 개선)
- 지도 시각화 성능 최적화 (대용량 데이터 처리)
- 사용자 설정 저장 기능

### 6.3 장기
- 사용자 피드백 기반 추가 개선
- 새로운 시각화 타입 추가
- 멀티 파일 비교 분석 기능

---

## 7. 개발 가이드라인 준수 사항

본 개선 작업 시 `docs/constitution.md`의 다음 규칙을 준수해야 합니다:

### 7.1 코드 스타일
- Python 3.10+ 타입 힌트 사용
- Google 스타일 docstring 작성
- 함수명: snake_case, 상수: UPPER_SNAKE_CASE
- 주석 및 docstring: 한글 작성

### 7.2 데이터 처리
- CSV 인코딩 순서: UTF-8 → UTF-8-SIG → CP949
- 지도 시각화 최대 포인트: 5,000개 (초과 시 샘플링)

### 7.3 개발 철학
- **단순성 우선**: 복잡한 로직보다 이해하기 쉬운 코드
- **교육 목적 중심**: 초보자도 읽고 이해할 수 있어야 함
- **데이터 탐색 중심**: 모델링보다 데이터 이해와 시각화에 집중

---

## Document History

| 버전 | 날짜 | 작성자 | 변경 사항 |
|------|------|--------|----------|
| v1.0 | 2025-12-12 | Claude | v1.2.4 note.md 기반 최초 작성 |
