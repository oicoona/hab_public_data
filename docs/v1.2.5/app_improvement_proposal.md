# 대구 공공데이터 시각화 앱 개선 제안서 (v1.2.4 → v1.2.5)

**문서 버전**: v1.2.5
**작성일**: 2025-12-12
**참고 문서**: `docs/v1.2.5/note.md`

---

## 1. 개요

본 문서는 대구 공공데이터 시각화 앱 v1.2.4의 현재 상태(AS-IS)와 v1.2.5에서 목표하는 개선 상태(TO-BE)를 비교 분석한다. 시계열 데이터 처리 문제 해결 및 다중 데이터셋 분석 기능 추가를 통해 사용성과 분석 능력을 향상시키는 것이 목표이다.

---

## 2. 기능별 AS-IS / TO-BE 비교

### 2.1 시계열 데이터 처리

| 구분 | AS-IS (v1.2.4) | TO-BE (v1.2.5) |
|:-----|:------------------------|:----------------------|
| **날짜 컬럼 타입** | 문자열(object)로 읽힘 | datetime64 타입으로 자동 변환 |
| **시계열 분석** | 날짜 타입 미인식으로 분석 불가 | 날짜 기반 시계열 분석 가능 |
| **영향 데이터셋** | CCTV, 보안등, 사고, train, test | 모든 날짜 컬럼 자동 파싱 |
| **사용자 경험** | 수동 변환 필요, 오류 발생 가능 | 투명한 자동 처리 |

#### 2.1.1 영향 받는 컬럼

| 데이터셋 | 컬럼명 | AS-IS 타입 | TO-BE 타입 |
|:---------|:-------|:-----------|:-----------|
| 대구 CCTV 정보 | 설치연도 | object | datetime64 |
| 대구 보안등 정보 | 설치연도 | object | datetime64 |
| countrywide_accident | 사고일시 | object | datetime64 |
| train | 사고일시 | object | datetime64 |
| test | 사고일시 | object | datetime64 |

#### 2.1.2 구현 위치

**파일**: `utils/loader.py`
**함수**: `load_dataset()`

```python
# 데이터셋별 날짜 컬럼 매핑
date_columns = {
    'cctv': ['설치연도'],
    'lights': ['설치연도'],
    'accident': ['사고일시'],
    'train': ['사고일시'],
    'test': ['사고일시']
}

# Convert date columns to datetime
if dataset_name in date_columns:
    for col in date_columns[dataset_name]:
        if col in df.columns:
            try:
                df[col] = pd.to_datetime(df[col], errors='coerce')
            except Exception as e:
                print(f"Warning: Could not convert {col} to datetime: {e}")
```

---

### 2.2 데이터 질의응답 - 다중 데이터셋 선택

| 구분 | AS-IS (v1.2.4) | TO-BE (v1.2.5) |
|:-----|:------------------------|:----------------------|
| **선택 방식** | selectbox (단일 선택) | checkbox (다중 선택) |
| **선택 가능 개수** | 1개만 선택 | 1개 이상 다중 선택 |
| **분석 범위** | 단일 데이터셋 분석 | 다중 데이터셋 상관/연관 분석 |
| **UI 레이아웃** | 드롭다운 메뉴 | 3열 체크박스 그리드 |
| **선택 시각화** | 드롭다운에서만 확인 | 체크박스 + 선택 요약 표시 |

#### 2.2.1 UI 변경 사항

**AS-IS (v1.2.4)**:
```python
selected_display_name = st.selectbox(
    "분석할 데이터셋 선택:",
    options=list(uploaded_datasets.keys()),
    key="chatbot_dataset"
)
```

**TO-BE (v1.2.5)**:
```python
# 3-column layout for checkboxes
cols = st.columns(3)
selected_datasets = []

for idx, (display_name, key) in enumerate(uploaded_datasets.items()):
    col_idx = idx % 3
    with cols[col_idx]:
        icon = DATASET_MAPPING[key]['tab_icon']
        if st.checkbox(f"{icon} {display_name}", key=f"cb_{key}", value=(idx == 0)):
            selected_datasets.append((display_name, key))
```

#### 2.2.2 선택 정보 표시

**TO-BE 추가 기능**:
```python
# 선택된 데이터셋 요약 표시
st.info(f"✅ 선택된 데이터셋: {', '.join([name for name, _ in selected_datasets])}")
```

---

### 2.3 데이터 컨텍스트 관리

| 구분 | AS-IS (v1.2.4) | TO-BE (v1.2.5) |
|:-----|:------------------------|:----------------------|
| **컨텍스트 범위** | 단일 데이터셋 정보만 전달 | 선택된 모든 데이터셋 정보 병합 |
| **캐싱 전략** | 데이터셋별 개별 캐싱 | 데이터셋별 캐싱 + 동적 병합 |
| **채팅 세션** | 데이터셋별 단일 세션 | 선택 조합별 독립 세션 |
| **세션 키** | `{dataset_name}` | `{dataset1}_{dataset2}_...` (정렬) |

#### 2.3.1 다중 데이터 컨텍스트 생성

```python
# v1.2.5: 다중 데이터셋 컨텍스트
multi_data_context = ""
for key, info in loaded_datasets.items():
    cache_key = f"context_{key}_{len(info['data'])}"
    if cache_key not in st.session_state:
        st.session_state[cache_key] = create_data_context(info['data'], info['name'])
    multi_data_context += f"\n\n### {info['name']} 데이터셋\n{st.session_state[cache_key]}"
```

#### 2.3.2 채팅 세션 키 생성

```python
# 선택된 데이터셋 조합으로 세션 키 생성
chat_session_key = "_".join(sorted([key for _, key in selected_datasets]))
chat_history = get_chat_history(chat_session_key)
```

---

### 2.4 데이터셋 요약 표시

| 구분 | AS-IS (v1.2.4) | TO-BE (v1.2.5) |
|:-----|:------------------------|:----------------------|
| **표시 방식** | 단일 데이터셋 요약 (10행) | 선택된 모든 데이터셋 요약 (각 3행) |
| **메트릭 표시** | 행 수, 컬럼 수, 전체 결측률 | 행 수, 컬럼 수, 결측률 (데이터셋별) |
| **접기/펴기** | expandable 컨테이너 | expandable 컨테이너 (개선) |

---

## 3. 코드 품질 개선

### 3.1 타입 안정성 개선

| 위치 | AS-IS (v1.2.4) | TO-BE (v1.2.5) | 심각도 |
|:-----|:------------------------|:----------------------|:-------|
| `utils/loader.py:94` | 날짜 컬럼 타입 불확실성 | datetime64 타입 보장 | 🟡 Performance |
| `app.py:1054` | 단일 데이터셋 가정 | 다중 데이터셋 지원 | 🔧 Enhancement |

### 3.2 에러 처리 강화

**utils/loader.py**:
```python
# TO-BE: 날짜 변환 실패 시 경고만 출력하고 계속 진행
try:
    df[col] = pd.to_datetime(df[col], errors='coerce')
except Exception as e:
    print(f"Warning: Could not convert {col} to datetime: {e}")
```

---

## 4. 변경 요약표

| 영역 | 변경 유형 | 내용 |
|:-----|:---------|:-----|
| 데이터 로딩 | 🔧 개선 | 날짜 컬럼 자동 datetime 변환 추가 |
| 데이터셋 선택 UI | 🔄 변경 | selectbox → checkbox (다중 선택) |
| 채팅 컨텍스트 | ➕ 추가 | 다중 데이터셋 컨텍스트 병합 기능 |
| 채팅 세션 관리 | 🔄 변경 | 선택 조합별 독립 세션 관리 |
| 데이터셋 요약 | 🔄 변경 | 다중 데이터셋 개별 요약 표시 |

---

## 5. 구현 우선순위

### 🔴 P0 - 핵심 기능 개선 (필수)

| 순위 | 항목 | 설명 |
|:-----|:-----|:-----|
| 1 | 날짜 컬럼 자동 변환 | 시계열 분석을 위한 필수 전처리 |
| 2 | 다중 데이터셋 선택 UI | 상관 분석을 위한 핵심 기능 |

### 🟡 P1 - 사용자 경험 개선

| 순위 | 항목 | 설명 |
|:-----|:-----|:-----|
| 3 | 선택 데이터셋 요약 표시 | 사용자가 선택한 데이터 확인 |
| 4 | 세션 키 관리 개선 | 선택 조합별 대화 내역 분리 |

### 🟢 P2 - 추가 개선

| 순위 | 항목 | 설명 |
|:-----|:-----|:-----|
| 5 | 에러 메시지 개선 | 날짜 변환 실패 시 사용자 알림 |
| 6 | 성능 최적화 | 다중 데이터셋 로딩 캐싱 전략 |

---

## 6. 구현 상태

### ✅ 완료된 항목

| 항목 | 파일 | 라인 | 완료일 |
|:-----|:-----|:-----|:-------|
| 날짜 컬럼 자동 변환 | `utils/loader.py` | 119-145 | 2025-12-12 |
| 다중 선택 체크박스 UI | `app.py` | 1053-1065 | 2025-12-12 |
| 다중 데이터셋 로딩 | `app.py` | 1074-1086 | 2025-12-12 |
| 다중 컨텍스트 생성 | `app.py` | 1144-1150 | 2025-12-12 |
| 세션 키 관리 개선 | `app.py` | 1107-1109 | 2025-12-12 |
| 데이터셋 요약 개선 | `app.py` | 1088-1103 | 2025-12-12 |

### 🔄 진행 중인 항목

없음

### ⏳ 계획된 항목

| 항목 | 우선순위 | 예상 난이도 |
|:-----|:---------|:-----------|
| 다중 데이터셋 Tool 실행 개선 | P2 | 중간 |
| 날짜 형식 자동 감지 강화 | P2 | 낮음 |

---

## 7. 예상 UI 구조

```
┌─────────────────────────────────────────────────────────────┐
│  💬 데이터 질의응답                                          │
│  업로드한 데이터셋에 대해 AI에게 질문하세요.                 │
│  여러 데이터셋을 선택하여 상관 분석도 가능합니다.            │
├─────────────────────────────────────────────────────────────┤
│  📊 분석할 데이터셋 선택                                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                  │
│  │☑️ 🎥 CCTV │  │☑️ 💡 보안등│  │☐ 🏫 보호구역│                │
│  └──────────┘  └──────────┘  └──────────┘                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                  │
│  │☐ 🅿️ 주차장│  │☑️ 🚗 사고  │  │☐ 📊 훈련   │                │
│  └──────────┘  └──────────┘  └──────────┘                  │
│                                                             │
│  ✅ 선택된 데이터셋: CCTV, 보안등, 사고                      │
├─────────────────────────────────────────────────────────────┤
│  📊 선택된 데이터셋 요약 ▼                                   │
│  ├─ CCTV: 1,234행 × 10컬럼 (결측률 2.3%)                    │
│  ├─ 보안등: 5,678행 × 8컬럼 (결측률 1.5%)                    │
│  └─ 사고: 9,012행 × 15컬럼 (결측률 0.8%)                     │
├─────────────────────────────────────────────────────────────┤
│  대화 내역                                                  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ 👤 CCTV와 사고의 상관관계는?                           │  │
│  │ 🤖 CCTV 설치 지역과 사고 발생률을 분석한 결과...      │  │
│  │ 👤 보안등 설치 연도별 추이는?                         │  │
│  │ 🤖 보안등 설치는 2015년부터 급증했습니다...          │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                             │
│  💬 데이터에 대해 질문하세요...                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 8. 다음 단계

1. **P0 구현 완료**: ✅ 날짜 컬럼 자동 변환 및 다중 데이터셋 선택 기능
2. **P1 구현 완료**: ✅ 선택 데이터셋 요약 및 세션 관리
3. **테스트**: 전체 기능 통합 테스트 필요
   - 날짜 컬럼 타입 확인
   - 다중 데이터셋 선택/해제 동작
   - 채팅 세션 분리 확인
   - 상관 분석 질의 테스트
4. **문서화**:
   - README 업데이트 (v1.2.5 기능 추가)
   - CHANGELOG 작성
5. **P2 구현 계획**: 다중 데이터셋 Tool 실행 개선 검토

---

## 9. 참고 문서

- **Constitution**: `docs/constitution.md`
- **Note**: `docs/v1.2.5/note.md`
- **이전 버전**: `docs/v1.2.4/app_improvement_proposal.md`

---

## 10. 버전 히스토리

| 버전 | 작성일 | 주요 변경 사항 |
|:-----|:-------|:--------------|
| v1.2.5 | 2025-12-12 | 시계열 데이터 처리 개선, 다중 데이터셋 선택 기능 추가 |
